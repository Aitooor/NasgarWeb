<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nasgar | Shop</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/panel.css">
  <link rel="stylesheet" href="/css/sup.css">
  <link rel="shortcut icon" href="/img/logo-128x.png" type="image/x-icon">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Nasgar.online">
  <meta name="og:title" content="Nasgar Network | Shop">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="og:icon" content="/img/logo-128x.png">
  <meta name="description" content="description">
  <meta name="og:description" content="description">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <style>
    li p {
      margin-top: 20px;
      margin-bottom: 0px;
      color: rgba(240, 248, 255, 0.507);
    }

    ul li {
      margin: 0px 10px;
      text-align: left !important;
    }

    .categoryT,
    .categoryT2 {
      color: rgba(240, 248, 255, 0.507);
      padding: 0px !important;
    }

    .categorySub1 a {
      margin: 0px 10px 0px 15px;

    }

    .categorySub1 {
      padding-bottom: 0px !important;
    }

    .categorySub2 a {
      margin: 0px 10px 0px 25px;

    }

    .categorySub2 {
      padding-bottom: 0px !important;
    }

    .categoryT2 {
      margin: 0px 10px 0px 25px !important;
    }


    .card-body {
      transition-duration: 0.3s;
    }

    .card-body:hover {
      bottom: 30px;
      transform: translateY(-10px);
      font-weight: bolder !important;
    }

    .left-container {
      overflow-y: scroll;
    }

    ::-webkit-scrollbar {
      width: 7px;
    }

    ::-webkit-scrollbar-thumb {
      background: #1F4068;
    }

    @media (max-width: 768px) {
      li p {
        font-size: 15px;
      }
      .col-7, .col-2, .col-1 {
        width: 100% !important;
      }

      .col-7 div, .col-2 div, .col-1 div {
        width: 100% !important;
        text-align: center;
        align-items: center;
      } 
      .cart-img {
        display: flex;
        justify-content: center;
        align-items: center;
      }
    }
  </style>
  <script src="https://www.paypal.com/sdk/js?client-id=<%- paypalClient %>&components=buttons"></script>

  <script>
    var userLang = navigator.language || navigator.userLanguage;
  </script>

  <% if(!user && !translate){ %>
  <script type="text/javascript">
    var userLang = navigator.language || navigator.userLanguage;
    if (userLang.toLowerCase().includes('es')) window.location.assign('/shop?lang=es')
  </script>
  <% } %>


  <style>
    .cart-icon {
      background-color: #4f85c8;
      width: 50px;
      height: 50px;
      position: fixed;
      bottom: 50px;
      right: 50px;
      border-radius: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
      transition-duration: 0.3s;
      z-index: 30;
    }

    .cart-number {
      position: absolute;
      top: -2px;
      left: 0px;
      border-radius: 100%;
      background-color: #1F4068;
      width: 17px;
      height: 17px;
      text-align: center;
      justify-content: center;
      align-items: center;
      font-size: 13px;
    }

    .cart-icon:hover {
      width: 55px;
      height: 55px;
    }

    .modal-body * {
      margin: 0px !important;
    }

    .modal-body img {
      margin: 10px 0px !important;
    }

    .cart-text p {
      font-weight: lighter !important;
    }

    .cart-item {
      overflow-x: hidden !important;
    }

    .left-container {
      z-index: 500;
    }
  </style>

</head>

<body>

  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Your Cart</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="cartBody">
        </div>
        <div class="modal-footer">
          <p id="cartTotal">Total Price: $0</p>
          <a href="/shop/cartPayment" class="btn btn-primary">Checkout</a>
        </div>
      </div>
    </div>
  </div>


  <nav class="nav-container row">
    <div class="col-1"></div>
    <div class="col-2 coll">
      <a href="/"><img src="/img/logo-480x.png" alt="" height="50px"></a>
    </div>
    <div class="col-4 colm">
      <form action="/shop" method="get">
        <input type="text" name="product" placeholder="Product name or description" class="form-control">
        <input type="submit" value="Search" class="btn btn-primary">
      </form>
    </div>
    <div class="col-4 colr">
      <a href="/news" class="nav-btn">News</a>
      <a href="/shop" class="nav-btn">Shop</a>
      <a href="/bans" class="nav-btn">Bans</a>
      <a href="https://www.40servidoresmc.es/nasgar-network-votar" class="nav-btn" target="_blank">Vote</a>
      <% if(user) {%>
      <a class="nav-btn" href="/panel">
        <%- user.username %>
      </a>
      <% } else { %>
      <a class="nav-btn" href="/login">Login</a>
      <% } %>
    </div>
    <div class="col-1"></div>
  </nav>

  <div class="left-container unactive" id="left-container">
    <div class="leftBTNC">
      <i id="leftBTN" class="fa-solid fa-forward-step"></i>
    </div>
    <ul>
      <hr>
      <li><a class="optionTitle1" href="/">Home</a></li>
      <li><a class="optionTitle1" href="/panel">Panel</a></li>
    </ul>
  </div>

  <main>
    <br>
    <br>
    <div class="row" id="main">
    </div>
    <br>
    <div style="text-align: center;" id="cartPrice">Total price: $0</div>
    <br>
    <hr>
    <br>
    <div id="paybutton" style="display: flex; justify-content: center; align-items: center;"></div>
    <div class="separator"></div>

  </main>

  <script>
    AOS.init();
    const leftBTN = document.getElementById("leftBTN")
    const left = document.getElementById("left-container")
    left.addEventListener('click', () => {
      if (left.classList.contains('active')) left.classList.replace('active', 'unactive')
      else left.classList.replace('unactive', 'active')
    })

    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    const cart = getCookie("cartItems") ? JSON.parse(getCookie("cartItems")) : [];

    const unrealCart = new Map()

    cart.forEach(p => {
      if (unrealCart.has(p.product.id)) {
        const v = unrealCart.get(p.product.id)
        v.quantity += 1
        unrealCart.set(p.product.id, v)
      } else {
        p.quantity = 1
        unrealCart.set(p.product.id, p)
      }
    })

    unrealCart.forEach(p => {
      const html = `          <div class="cart-item row" id="${p.product.id}-${p.quantity}">
              <hr>
              <div class="cart-img col-2">
                <img src="${p.product.en.image}" alt="" width="64" height="64">
              </div>
              <div class="col-7 cart-text" style="display: flex; justify-content: rigth; align-items: center;">
                <div>
                  <strong>${p.product.en.name}</strong>
                  <p style="font-weight: lighter !important;">${p.product.en.description.length >= 50 ?  p.product.en.description.slice(0,50)+"..." : p.product.en.description}</p>
                </div>
              </div>
              <div class="col-2" style="display: flex; justify-content: center; align-items: center;">
                <p>$${p.product.price}</p>
              </div>
              <div class="col-1" style="display: flex; justify-content: center; align-items: center; text-align:center">
                <p>x${p.quantity}</p>
              </div>

              <hr>
            </div>`;
      document.getElementById("main").insertAdjacentHTML('afterbegin', html)

    })


    const cartPrice = document.getElementById("cartPrice");

    cartPrice.textContent = `Total Price: $${cart.reduce((prev,now)=>{
        return prev += now.product.price
    }, 0)}`

    paypal.Buttons({
      createOrder: function(data, actions) {
        // Set up the transaction
        return actions.order.create({
          purchase_units: [{
            amount: {
              value: cart.reduce((prev, now) => {
                return prev += now.product.price
              }, 0)
            }
          }]
        });
      },
      onApprove: function(data, actions) {
        // This function captures the funds from the transaction.
        return actions.order.capture().then(function(details) {
          // This function shows a transaction success message to your buyer.
          const body = {
            details: details,
            user: <%- user ? JSON.stringify(user._doc.username) : 'null' %>,
            products: cart.map(product => {
              return product.product.id
            })
          }
          fetch('/shop/verify', {
            method: 'POST',
            body: JSON.stringify(body)
          })
        });
      }

    }).render("#paybutton");
  </script>
</body>

</html>